name: Test

on:
  push:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      IMAGE_PATH: ${{ secrets.IMAGE_PATH || format('ghcr.io/{0}/', github.repository) }}
      NETCLICS_BASE_URL: https://localhost:8443
      NETCLICS_CONFIG: config/netclics-ci.json
    steps:
      - uses: actonlang/setup-acton@v1
        with:
          channel: 'tip'
      - name: "Cache acton stuff"
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/acton
            ~/.cache/ayang
            out/
            !out/bin
          # Hacky cache update:
          # https://github.com/actions/cache/blob/main/tips-and-workarounds.md#update-a-cache
          key: acton-${{ github.run_id }}
          restore-keys: |
            acton

      - name: Set up env for containers
        run: |
          # IOS XRd
          sudo sysctl -w fs.inotify.max_user_instances=64000
          # cRPD
          sudo apt-get update
          sudo apt-get install -qy linux-modules-extra-$(uname -r)
          sudo modprobe mpls_router mpls_gso vrf

      - name: "Install dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y jq sshpass
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

      - name: "Check out repository code"
        uses: actions/checkout@v4

      - name: "Check out licenses repo"
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/licenses
          path: router-licenses
          ssh-key: ${{ secrets.LICENSES_PRIVATE_KEY }}

      - name: Login to ghcr.io
        if: ${{ startsWith(env.IMAGE_PATH, 'ghcr.io') }}
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: "Build NETCLICS"
        run: just build

      - name: "Start NETCLICS server in background"
        run: |
          just run-https > netclics.log 2>&1 &
          echo $! > netclics.pid
          echo "NETCLICS server started with PID $(cat netclics.pid)"

      - name: "Test platforms endpoint"
        run: just platforms

      - name: "Test instances endpoint"
        run: just instances

      - name: "Wait for all instances to be ready"
        run: just wait-for-instances 900

      - name: "Wait for all schemas to be compiled"
        run: just wait-for-schemas

      - name: "Test XML to XML conversion"
        run: just test-xml-to-xml-crpd

      - name: "Test CLI to NETCONF conversion"
        run: just test-cli-to-netconf

      - name: "Test NETCONF to CLI conversion"
        run: just test-netconf-to-cli

      - name: "Test CLI to CLI roundtrip"
        run: just test-cli-to-cli

      - name: "Test CLI to Acton adata conversion"
        run: just test-cli-to-acton-adata

      - name: "Test CLI to Acton gdata conversion"
        run: just test-cli-to-acton-gdata

      - name: "Test CLI to JSON conversion"
        run: just test-cli-to-json

      - name: "Test NETCONF error handling"
        run: just test-netconf-error

      # IOS XRd Tests
      - name: "Test IOS XRd CLI to Acton adata conversion"
        run: just test-iosxrd-cli-to-acton-adata

      - name: "Test IOS XRd CLI to Acton adata conversion (Unified Model module-set)"
        run: just test-iosxrd-cli-to-acton-adata-unified-model

      - name: "Test IOS XRd CLI to CLI roundtrip"
        run: just test-iosxrd-cli-to-cli

      - name: "Test IOS XRd NETCONF to CLI conversion"
        run: just test-iosxrd-netconf-to-cli

      - name: "Test IOS XRd CLI to NETCONF conversion"
        run: just test-iosxrd-cli-to-netconf

      - name: "Test IOS XRd CLI to JSON conversion"
        run: just test-iosxrd-cli-to-json

      # IOS XE Tests
      - name: "Test IOS XE CLI to Acton adata conversion"
        run: just test-iosxe-cli-to-acton-adata

      - name: "Test IOS XE CLI to CLI roundtrip"
        run: just test-iosxe-cli-to-cli

      - name: "Test IOS XE NETCONF to CLI conversion"
        run: just test-iosxe-netconf-to-cli

      - name: "Test IOS XE CLI to NETCONF conversion"
        run: just test-iosxe-cli-to-netconf

      - name: "Test IOS XE CLI to JSON conversion"
        run: just test-iosxe-cli-to-json

      # Multi-step Configuration Tests
      - name: "Test multi-step configuration (cRPD)"
        run: just test-multi-step

      - name: "Test multi-step CLI to CLI (cRPD)"
        run: just test-multi-step-cli-to-cli

      - name: "Test multi-step NETCONF to CLI (cRPD)"
        run: just test-multi-step-netconf-to-cli

      - name: "Test multi-step configuration (IOS XE)"
        run: just test-multi-step-iosxe

      - name: "Test multi-step CLI to CLI (IOS XE)"
        run: just test-multi-step-iosxe-cli-to-cli

      - name: "Test multi-step configuration (IOS XR)"
        run: just test-multi-step-iosxr

      # MCP Protocol Tests
      - name: "Test MCP initialize"
        run: just test-mcp-initialize

      - name: "Test MCP tools list"
        run: just test-mcp-tools-list

      - name: "Test MCP list platforms"
        run: just test-mcp-platforms

      - name: "Test MCP list instances"
        run: just test-mcp-instances

      - name: "Test MCP convert config"
        run: just test-mcp-convert

      - name: "Stop NETCLICS server"
        if: always()
        run: |
          if [ -f netclics.pid ]; then
            kill $(cat netclics.pid) || true
            rm netclics.pid
          fi

      - name: "Upload NETCLICS logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: netclics-logs
          path: netclics.log

      - name: "Stop dynamic instances"
        if: always()
        run: just stop-dynamic-instances || true
